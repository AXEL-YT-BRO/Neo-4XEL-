<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neo 4XEL | Universal AI Interface</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        gray: {
                            750: '#2d3748',
                            850: '#1a202c',
                            950: '#0d1117',
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; 
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; 
        }

        /* Markdown Styles within chat */
        .prose pre {
            background-color: #1e1e1e;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin: 1rem 0;
        }
        .prose code {
            color: #e0e0e0;
            font-family: 'Courier New', Courier, monospace;
        }
        .prose p {
            margin-bottom: 0.75rem;
        }
        .prose ul {
            list-style-type: disc;
            padding-left: 1.5rem;
            margin-bottom: 0.75rem;
        }
        .prose ol {
            list-style-type: decimal;
            padding-left: 1.5rem;
            margin-bottom: 0.75rem;
        }
        
        /* Loading Dots Animation */
        .typing-indicator span {
            animation: blink 1.4s infinite both;
            height: 6px;
            width: 6px;
            background-color: #9ca3af;
            border-radius: 50%;
            display: inline-block;
            margin: 0 1px;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes blink {
            0% { opacity: 0.2; }
            20% { opacity: 1; }
            100% { opacity: 0.2; }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans h-screen flex overflow-hidden">

    <div id="mobile-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden lg:hidden"></div>

    <aside id="sidebar" class="fixed inset-y-0 left-0 z-30 w-64 bg-gray-950 border-r border-gray-800 transform -translate-x-full transition-transform duration-300 lg:translate-x-0 lg:static lg:inset-auto flex flex-col">
        <div class="p-4 flex items-center justify-between border-b border-gray-800">
            <div class="flex items-center gap-2 font-semibold text-lg tracking-wide text-white">
                <i class="fa-solid fa-robot text-blue-500"></i> Neo 4XEL
            </div>
            <button id="close-sidebar" class="lg:hidden text-gray-400 hover:text-white">
                <i class="fa-solid fa-times"></i>
            </button>
        </div>

        <div class="p-3">
            <button id="new-chat-btn" class="w-full flex items-center gap-3 px-4 py-3 bg-gray-800 hover:bg-gray-700 text-sm text-white rounded-lg transition-colors border border-gray-700">
                <i class="fa-solid fa-plus"></i> New Chat
            </button>
        </div>

        <div class="flex-1 overflow-y-auto p-3 space-y-1" id="history-list">
            <div class="text-center text-gray-500 text-xs mt-4">No chat history</div>
        </div>

        <div class="p-4 border-t border-gray-800">
            <button id="open-settings" class="flex items-center gap-3 text-sm text-gray-400 hover:text-white transition-colors w-full">
                <i class="fa-solid fa-gear"></i> Settings
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-full relative">
        <header class="flex items-center justify-between p-4 border-b border-gray-800 lg:hidden bg-gray-900">
            <button id="open-sidebar" class="text-gray-400 hover:text-white">
                <i class="fa-solid fa-bars text-xl"></i>
            </button>
            <span class="font-semibold">Neo 4XEL</span>
            <div class="w-6"></div> </header>

        <div id="welcome-screen" class="absolute inset-0 flex flex-col items-center justify-center text-center p-6 z-0">
            <div class="w-16 h-16 bg-gray-800 rounded-full flex items-center justify-center mb-6">
                <i class="fa-solid fa-bolt text-3xl text-blue-500"></i>
            </div>
            <h1 class="text-3xl font-bold mb-2 text-white">Hello, I'm Neo 4XEL</h1>
            <p class="text-gray-400 max-w-md mb-8">
                Your universal AI assistant. Configure your API key in settings to get started.
            </p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full max-w-2xl">
                <button class="suggestion-btn bg-gray-800 hover:bg-gray-750 p-4 rounded-xl text-left transition border border-gray-700">
                    <h3 class="font-medium text-white mb-1">Explain Quantum Computing</h3>
                    <p class="text-xs text-gray-400">Like I'm five years old</p>
                </button>
                <button class="suggestion-btn bg-gray-800 hover:bg-gray-750 p-4 rounded-xl text-left transition border border-gray-700">
                    <h3 class="font-medium text-white mb-1">Write a Python Script</h3>
                    <p class="text-xs text-gray-400">To parse a CSV file</p>
                </button>
            </div>
        </div>

        <div id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 z-10 hidden scroll-smooth pb-32">
            </div>

        <div class="p-4 bg-gray-900 border-t border-gray-800 z-20">
            <div class="max-w-4xl mx-auto relative">
                <form id="chat-form" class="relative">
                    <textarea 
                        id="user-input" 
                        rows="1" 
                        placeholder="Message Neo 4XEL..." 
                        class="w-full bg-gray-800 text-white placeholder-gray-500 rounded-2xl pl-5 pr-12 py-4 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none overflow-hidden"
                        style="min-height: 56px; max-height: 200px;"
                    ></textarea>
                    <button 
                        type="submit" 
                        id="send-btn"
                        class="absolute right-3 bottom-3 p-2 bg-blue-600 hover:bg-blue-700 text-white rounded-xl transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled
                    >
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </form>
                <p class="text-center text-xs text-gray-500 mt-2">
                    Neo 4XEL can make mistakes. Verify important information.
                </p>
            </div>
        </div>
    </main>

    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-gray-900 border border-gray-700 rounded-2xl w-full max-w-md shadow-2xl transform transition-all scale-95 opacity-0" id="modal-content">
            <div class="p-6 border-b border-gray-800 flex justify-between items-center">
                <h2 class="text-xl font-semibold text-white">Settings</h2>
                <button id="close-modal" class="text-gray-400 hover:text-white">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">OpenRouter API Key</label>
                    <input type="password" id="api-key" placeholder="sk-or-..." class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500">
                    <p class="text-xs text-gray-500 mt-1">Key is stored locally in your browser.</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Model ID</label>
                    <input type="text" id="model-id" value="google/gemini-2.0-flash-exp:free" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500">
                    <p class="text-xs text-gray-500 mt-1">Default: Gemini 2.0 Flash (Free via OpenRouter)</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">System Prompt</label>
                    <textarea id="system-prompt" rows="3" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500">You are Neo 4XEL, a helpful and intelligent AI assistant.</textarea>
                </div>
            </div>
            <div class="p-6 border-t border-gray-800 flex justify-end">
                <button id="save-settings" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                    Save
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration & State ---
        const CONFIG_KEY = 'neo4xel_config';
        const HISTORY_KEY = 'neo4xel_history';
        
        let state = {
            config: {
                apiKey: '',
                model: 'google/gemini-2.0-flash-exp:free',
                systemPrompt: 'You are Neo 4XEL, a helpful and intelligent AI assistant.'
            },
            history: [], // Array of { id, title, messages: [] }
            currentChatId: null,
            isGenerating: false
        };

        // --- DOM Elements ---
        const els = {
            sidebar: document.getElementById('sidebar'),
            mobileOverlay: document.getElementById('mobile-overlay'),
            openSidebarBtn: document.getElementById('open-sidebar'),
            closeSidebarBtn: document.getElementById('close-sidebar'),
            chatContainer: document.getElementById('chat-container'),
            welcomeScreen: document.getElementById('welcome-screen'),
            chatForm: document.getElementById('chat-form'),
            userInput: document.getElementById('user-input'),
            sendBtn: document.getElementById('send-btn'),
            historyList: document.getElementById('history-list'),
            newChatBtn: document.getElementById('new-chat-btn'),
            settingsModal: document.getElementById('settings-modal'),
            modalContent: document.getElementById('modal-content'),
            openSettingsBtn: document.getElementById('open-settings'),
            closeModalBtn: document.getElementById('close-modal'),
            saveSettingsBtn: document.getElementById('save-settings'),
            apiKeyInput: document.getElementById('api-key'),
            modelIdInput: document.getElementById('model-id'),
            systemPromptInput: document.getElementById('system-prompt'),
            suggestionBtns: document.querySelectorAll('.suggestion-btn')
        };

        // --- Initialization ---
        function init() {
            // Load from LocalStorage
            const storedConfig = localStorage.getItem(CONFIG_KEY);
            const storedHistory = localStorage.getItem(HISTORY_KEY);

            if (storedConfig) state.config = JSON.parse(storedConfig);
            if (storedHistory) state.history = JSON.parse(storedHistory);

            // Populate Settings
            els.apiKeyInput.value = state.config.apiKey;
            els.modelIdInput.value = state.config.model;
            els.systemPromptInput.value = state.config.systemPrompt;

            renderHistory();
            startNewChat();

            // Setup Highlight.js and Marked options
            marked.setOptions({
                highlight: function(code, lang) {
                    const language = highlight.getLanguage(lang) ? lang : 'plaintext';
                    return highlight.highlight(code, { language }).value;
                },
                langPrefix: 'hljs language-'
            });
        }

        // --- Logic: Chat Management ---
        function startNewChat() {
            state.currentChatId = Date.now().toString();
            state.history.unshift({
                id: state.currentChatId,
                title: 'New Chat',
                messages: []
            });
            saveHistory();
            renderHistory();
            clearChatUI();
            toggleWelcomeScreen(true);
            
            // On mobile, close sidebar when starting new chat
            if (window.innerWidth < 1024) closeSidebar();
        }

        function loadChat(chatId) {
            const chat = state.history.find(c => c.id === chatId);
            if (!chat) return;

            state.currentChatId = chatId;
            renderHistory(); // Update active state in sidebar
            
            // Render Messages
            els.chatContainer.innerHTML = '';
            chat.messages.forEach(msg => appendMessageToUI(msg.role, msg.content));
            
            toggleWelcomeScreen(chat.messages.length === 0);
            
            if (window.innerWidth < 1024) closeSidebar();
            
            // Scroll to bottom
            els.chatContainer.scrollTop = els.chatContainer.scrollHeight;
        }

        function saveHistory() {
            localStorage.setItem(HISTORY_KEY, JSON.stringify(state.history));
        }

        function deleteChat(e, chatId) {
            e.stopPropagation(); // Prevent loading the chat
            state.history = state.history.filter(c => c.id !== chatId);
            saveHistory();
            
            if (state.currentChatId === chatId) {
                startNewChat();
            } else {
                renderHistory();
            }
        }

        // --- Logic: API Interaction ---
        async function handleSendMessage(content) {
            if (!content.trim() || state.isGenerating) return;
            
            if (!state.config.apiKey) {
                alert('Please enter your OpenRouter API Key in Settings.');
                openModal();
                return;
            }

            // 1. Update UI with User Message
            state.isGenerating = true;
            els.sendBtn.disabled = true;
            els.userInput.value = '';
            resetTextareaHeight();
            toggleWelcomeScreen(false);
            
            appendMessageToUI('user', content);
            addMessageToHistory('user', content);

            // 2. Create Placeholder for Bot Message
            const botMessageDiv = appendMessageToUI('assistant', '', true); // true = loading state
            const botContentDiv = botMessageDiv.querySelector('.message-content');
            let fullResponse = '';

            try {
                // Prepare Context (System Prompt + Last 10 messages for context window)
                const chatHistory = state.history.find(c => c.id === state.currentChatId).messages;
                const messagesPayload = [
                    { role: 'system', content: state.config.systemPrompt },
                    ...chatHistory.slice(-10) 
                ];

                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${state.config.apiKey}`,
                        "HTTP-Referer": window.location.href, // Required by OpenRouter
                        "X-Title": "Neo 4XEL", // Required by OpenRouter
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        "model": state.config.model,
                        "messages": messagesPayload,
                        "stream": true // Enable streaming
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'API Request Failed');
                }

                // Stream Reading
                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");
                
                // Remove loading indicator immediately before streaming starts
                botContentDiv.innerHTML = ''; 

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split("\n");
                    
                    for (const line of lines) {
                        if (line.startsWith("data: ") && line !== "data: [DONE]") {
                            try {
                                const data = JSON.parse(line.slice(6));
                                const content = data.choices[0]?.delta?.content || "";
                                fullResponse += content;
                                botContentDiv.innerHTML = marked.parse(fullResponse);
                                hljs.highlightAll(); // Re-highlight code blocks
                                
                                // Auto-scroll to bottom
                                els.chatContainer.scrollTop = els.chatContainer.scrollHeight;
                            } catch (e) {
                                console.error("Error parsing stream:", e);
                            }
                        }
                    }
                }

                // Finalize
                addMessageToHistory('assistant', fullResponse);
                
                // Update Chat Title if it's the first message
                const currentChat = state.history.find(c => c.id === state.currentChatId);
                if (currentChat.messages.length === 2) { // 1 user + 1 bot
                    // Simple logic: use first 30 chars of user message
                    currentChat.title = content.substring(0, 30) + (content.length > 30 ? '...' : '');
                    saveHistory();
                    renderHistory();
                }

            } catch (error) {
                botContentDiv.innerHTML = `<span class="text-red-400">Error: ${error.message}</span>`;
                addMessageToHistory('assistant', `Error: ${error.message}`);
            } finally {
                state.isGenerating = false;
                els.sendBtn.disabled = false;
                updateSendButtonState();
            }
        }

        function addMessageToHistory(role, content) {
            const chat = state.history.find(c => c.id === state.currentChatId);
            if (chat) {
                chat.messages.push({ role, content });
                saveHistory();
            }
        }

        // --- UI Rendering & Helpers ---
        function renderHistory() {
            els.historyList.innerHTML = '';
            
            if (state.history.length === 0) {
                els.historyList.innerHTML = '<div class="text-center text-gray-500 text-xs mt-4">No chat history</div>';
                return;
            }

            state.history.forEach(chat => {
                const isActive = chat.id === state.currentChatId;
                const div = document.createElement('div');
                div.className = `group flex items-center justify-between p-3 rounded-lg cursor-pointer transition-colors ${isActive ? 'bg-gray-800 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}`;
                div.onclick = () => loadChat(chat.id);
                
                div.innerHTML = `
                    <div class="flex items-center gap-3 overflow-hidden">
                        <i class="fa-regular fa-message text-xs"></i>
                        <span class="text-sm truncate w-32">${chat.title}</span>
                    </div>
                    <button class="opacity-0 group-hover:opacity-100 hover:text-red-400 transition-opacity p-1" onclick="deleteChat(event, '${chat.id}')">
                        <i class="fa-solid fa-trash text-xs"></i>
                    </button>
                `;
                els.historyList.appendChild(div);
            });
        }

        function appendMessageToUI(role, content, isLoading = false) {
            const isUser = role === 'user';
            
            const msgDiv = document.createElement('div');
            msgDiv.className = `flex gap-4 ${isUser ? 'justify-end' : 'justify-start'}`;
            
            const avatar = isUser 
                ? `<div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center flex-shrink-0"><i class="fa-solid fa-user text-sm"></i></div>`
                : `<div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center flex-shrink-0"><i class="fa-solid fa-bolt text-sm"></i></div>`;
            
            const loadingHtml = `<div class="typing-indicator flex items-center h-6 gap-1"><span></span><span></span><span></span></div>`;
            
            // If it's a user, content is plain text (but safely escaped). If bot, it's Markdown.
            // For the initial append, we might pass raw text.
            const contentHtml = isLoading ? loadingHtml : (isUser ? `<p>${escapeHtml(content)}</p>` : marked.parse(content));

            msgDiv.innerHTML = `
                ${!isUser ? avatar : ''}
                <div class="max-w-[85%] lg:max-w-[75%]">
                    <div class="text-xs text-gray-400 mb-1 ${isUser ? 'text-right' : 'text-left'}">${isUser ? 'You' : 'Neo 4XEL'}</div>
                    <div class="message-content prose prose-invert text-sm bg-${isUser ? 'gray-800' : 'transparent'} p-${isUser ? '4' : '0'} rounded-2xl ${isUser ? 'rounded-tr-none' : ''} leading-relaxed">
                        ${contentHtml}
                    </div>
                </div>
                ${isUser ? avatar : ''}
            `;
            
            els.chatContainer.appendChild(msgDiv);
            els.chatContainer.scrollTop = els.chatContainer.scrollHeight;
            
            // Highlight code if content exists
            if (!isLoading && !isUser) hljs.highlightAll();

            return msgDiv; // Return reference to update later (for streaming)
        }

        function clearChatUI() {
            els.chatContainer.innerHTML = '';
        }

        function toggleWelcomeScreen(show) {
            if (show) {
                els.welcomeScreen.classList.remove('hidden');
                els.chatContainer.classList.add('hidden');
            } else {
                els.welcomeScreen.classList.add('hidden');
                els.chatContainer.classList.remove('hidden');
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updateSendButtonState() {
            if (!els.userInput.value.trim() || state.isGenerating) {
                els.sendBtn.disabled = true;
                els.sendBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                els.sendBtn.disabled = false;
                els.sendBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        function resetTextareaHeight() {
            els.userInput.style.height = 'auto';
        }

        // --- Sidebar Logic ---
        function openSidebar() {
            els.sidebar.classList.remove('-translate-x-full');
            els.mobileOverlay.classList.remove('hidden');
        }

        function closeSidebar() {
            els.sidebar.classList.add('-translate-x-full');
            els.mobileOverlay.classList.add('hidden');
        }

        // --- Modal Logic ---
        function openModal() {
            els.settingsModal.classList.remove('hidden');
            // Small timeout for transition effect
            setTimeout(() => {
                els.modalContent.classList.remove('scale-95', 'opacity-0');
                els.modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeModal() {
            els.modalContent.classList.remove('scale-100', 'opacity-100');
            els.modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                els.settingsModal.classList.add('hidden');
            }, 200);
        }

        function saveSettings() {
            state.config.apiKey = els.apiKeyInput.value.trim();
            state.config.model = els.modelIdInput.value.trim();
            state.config.systemPrompt = els.systemPromptInput.value.trim();
            
            localStorage.setItem(CONFIG_KEY, JSON.stringify(state.config));
            closeModal();
        }

        // --- Event Listeners ---
        // Sidebar Toggles
        els.openSidebarBtn.addEventListener('click', openSidebar);
        els.closeSidebarBtn.addEventListener('click', closeSidebar);
        els.mobileOverlay.addEventListener('click', closeSidebar);

        // New Chat
        els.newChatBtn.addEventListener('click', startNewChat);

        // Settings Modal
        els.openSettingsBtn.addEventListener('click', openModal);
        els.closeModalBtn.addEventListener('click', closeModal);
        els.saveSettingsBtn.addEventListener('click', saveSettings);
        els.settingsModal.addEventListener('click', (e) => {
            if (e.target === els.settingsModal) closeModal();
        });

        // Chat Form
        els.chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            handleSendMessage(els.userInput.value);
        });

        // Textarea Auto-resize & Enter to send
        els.userInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
            updateSendButtonState();
        });

        els.userInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (!els.sendBtn.disabled) {
                    handleSendMessage(this.value);
                }
            }
        });

        // Suggestions
        els.suggestionBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const title = btn.querySelector('h3').innerText;
                const subtitle = btn.querySelector('p').innerText;
                handleSendMessage(`${title} ${subtitle}`);
            });
        });

        // Initialize App
        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
